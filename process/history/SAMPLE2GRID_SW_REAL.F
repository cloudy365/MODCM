C FILE: SAMPLE2GRID_SW.F
C USEAGE:
C       f2py -m sample2grid_sw -c SAMPLE2GRID_SW.F
C TO GENERATE PYTHON USABLE .SO FILE

       SUBROUTINE SORT(NUM_CHANNEL, NUM_LATS, NUM_LONS,  
     & NUM_SAMPLE, VALID_X, VALID_Y,
     & NUM_LINE, LATS, LONS, IDX_LATS, IDX_LONS, 
     & RADS, SOLS, RADS_MAX,
     & SUM_INSOL, SUM_RADIANCE, SUM_NUM)


C     NUMBER OF VALID SAMPLE (NUM_SAMPLE) AND CORRESPONDING INDEXES (VALID_X, VALID_Y)
C     NUMBER OF CHANNELS (NUM_CHANNEL)
      INTEGER NUM_CHANNEL, NUM_LATS, NUM_LONS, NUM_SAMPLE 
      INTEGER, DIMENSION(NUM_SAMPLE) :: VALID_X, VALID_Y


C     NUMBER OF IMAGE LINES AND CORRESPONDING LAT/LON (INDEXES)
      INTEGER NUM_LINE
      REAL, DIMENSION(NUM_LINE, 1354) :: LATS, LONS
      INTEGER, DIMENSION(NUM_LINE, 1354) :: IDX_LATS, IDX_LONS

C     GRANULE RADIANCE DATA
      REAL, DIMENSION(NUM_LINE, 1354, NUM_CHANNEL) :: RADS, SOLS
      REAL, DIMENSION(NUM_CHANNEL) :: RADS_MAX

C     OUTPUT ARRAY
      REAL, DIMENSION(NUM_LATS, NUM_LONS, NUM_CHANNEL) :: SUM_INSOL
      REAL, DIMENSION(NUM_LATS, NUM_LONS, NUM_CHANNEL) :: SUM_RADIANCE
      INTEGER, DIMENSION(NUM_LATS, NUM_LONS, NUM_CHANNEL) :: SUM_NUM


C     INTERNAL USE INDEXES
      INTEGER ISAMPLE, Y, X, IDX_X, IDX_Y, ICHANNEL
      REAL ILAT, ILON, ILAT_PRE
      REAL, DIMENSION(NUM_CHANNEL) :: IRAD, ISOL
      INTEGER, DIMENSION(NUM_CHANNEL) :: INUM


Cf2py intent(in) num_channel, num_lats, num_lons
Cf2py intent(in) num_sample, valid_x, valid_y 
Cf2py intent(in) num_line, lats, lons, idx_lats, idx_lons
Cf2py intent(in) rads, sols, rads_max
Cf2py intent(out) sum_insol, sum_radiance, sum_num
Cf2py depend(num_sample) valid_x, valid_y
Cf2py depend(num_line) lats, lons, idx_lats, idx_lons, rads, sols
Cf2py depend(num_channel) rads, sols, rads_max
Cf2py depend(num_channel) sum_insol, sum_radiance, sum_num
Cf2py depend(num_lats) sum_insol, sum_radiance, sum_num
Cf2py depend(num_lons) sum_insol, sum_radiance, sum_num


      SUM_INSOL = 0.0
      SUM_RADIANCE = 0.0
      SUM_NUM = 0


      DO ISAMPLE = 1, NUM_SAMPLE

C     ADD 1 SINCE FORTRAN STARTS FROM 1 WHILE LATS_IDX/LONS_IDX WERE 
C     GENERATED BY PYTHON.
         Y = VALID_Y(ISAMPLE) + 1
         X = VALID_X(ISAMPLE) + 1

         ILAT = LATS(Y, X)
         IF (Y.EQ.1) THEN
            ILAT_PRE = ILAT
         ELSE
            ILAT_PRE = LATS(Y-1, X)
         ENDIF
         ILON = LONS(Y, X)


C     FETCH INDEXES IN THE OUTPUT ARRAY.
C     ADD 1 DUE TO FORTRAN STARTS FROM 1 WHILE LATS_IDX/LONS_IDX WERE 
C     GENERATED BY PYTHON.
         IDX_Y = IDX_LATS(Y, X) + 1
         IDX_X = IDX_LONS(Y, X) + 1


C     CHECK LATLON USING ILAT, ILON, IDX_Y, IDX_X
         IF (ILAT.GE.ILAT_PRE .OR. ILAT.LE.-999. .OR. ILON.LE.-999
     & .OR. IDX_Y.EQ.NUM_LATS+1 .OR. IDX_X.EQ.NUM_LONS+1) THEN
            CYCLE
         ENDIF


C     CHECK RADIANCE ARRAY
        IRAD = RADS(Y, X, :)
        ISOL = SOLS(Y, X, :)
        INUM = 0
        
        DO ICHANNEL = 1, NUM_CHANNEL
            IF (IRAD(ICHANNEL).LE.0
     & .OR. IRAD(ICHANNEL).GT.RADS_MAX(ICHANNEL)) THEN
               IRAD(ICHANNEL) = 0.0
               ISOL(ICHANNEL) = 0.0
               INUM(ICHANNEL) = 0
            ELSE
               INUM(ICHANNEL) = 1
            ENDIF
         ENDDO


C          WRITE(*, *) I, J, IDX_Y, IDX_X
         SUM_INSOL(IDX_Y, IDX_X, :) = 
     & SUM_INSOL(IDX_Y, IDX_X, :) + ISOL
         SUM_RADIANCE(IDX_Y, IDX_X, :) = 
     & SUM_RADIANCE(IDX_Y, IDX_X, :) + IRAD
         SUM_NUM(IDX_Y, IDX_X, :) = 
     & SUM_NUM(IDX_Y, IDX_X, :) + INUM

      ENDDO


      SUM_INSOL = SUM_INSOL + CUMU_INSOL
      SUM_RADIANCE = SUM_RADIANCE + CUMU_RAD
      SUM_NUM = SUM_NUM + CUMU_NUM


      END
C END FILE SAMPLE2GRID_SW.F
